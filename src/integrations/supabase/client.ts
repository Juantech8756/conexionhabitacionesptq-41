
// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = "https://jnudcjgbplvxwrbnrlju.supabase.co";
const SUPABASE_PUBLISHABLE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpudWRjamdicGx2eHdyYm5ybGp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY3NjM1MTksImV4cCI6MjA2MjMzOTUxOX0.YFthBcpzlYQE8YcBAZCfUUj6GFjDIkhsxWxQl0vyQQ0";

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  realtime: {
    params: {
      eventsPerSecond: 10
    }
  }
});

// Create necessary storage buckets when the application starts
async function createStorageBuckets() {
  try {
    console.log("Initializing storage buckets...");
    
    // Check if buckets exist
    const { data: buckets, error: listError } = await supabase.storage.listBuckets();
    
    if (listError) {
      console.error('Error checking storage buckets:', listError);
      return;
    }
    
    // Check and create chat_media bucket
    const chatMediaBucket = buckets?.find(bucket => bucket.name === 'chat_media');
    
    if (!chatMediaBucket) {
      console.log('Creating chat_media storage bucket...');
      
      try {
        const { data, error } = await supabase.storage.createBucket('chat_media', {
          public: true,
          fileSizeLimit: 10485760, // 10MB limit
          allowedMimeTypes: ['image/*', 'video/*']
        });
        
        if (error) {
          console.error('Error creating chat_media bucket:', error);
          // If the error is due to RLS policy, we can't do much from the client
          if (error.message?.includes('row-level security policy')) {
            console.warn('Unable to create bucket due to Row Level Security policy. This might need to be created in the Supabase dashboard.');
          }
        } else {
          console.log('Created chat_media bucket successfully:', data);
        }
      } catch (createErr) {
        console.error('Failed to create chat_media bucket:', createErr);
      }
    } else {
      console.log('chat_media bucket already exists');
      
      // Ensure it's public
      try {
        const { data, error } = await supabase.storage.updateBucket('chat_media', {
          public: true,
          fileSizeLimit: 10485760,
          allowedMimeTypes: ['image/*', 'video/*']
        });
        
        if (error) {
          console.error('Error updating chat_media bucket settings:', error);
        } else {
          console.log('Updated chat_media bucket successfully:', data);
        }
      } catch (updateErr) {
        console.error('Error updating bucket settings:', updateErr);
      }
    }
    
    // Create audio_messages bucket if it doesn't exist
    const audioMessagesBucket = buckets?.find(bucket => bucket.name === 'audio_messages');
    
    if (!audioMessagesBucket) {
      console.log('Creating audio_messages storage bucket...');
      
      try {
        const { data, error } = await supabase.storage.createBucket('audio_messages', {
          public: true,
          fileSizeLimit: 10485760,
          allowedMimeTypes: ['audio/*']
        });
        
        if (error) {
          console.error('Error creating audio_messages bucket:', error);
        } else {
          console.log('Created audio_messages bucket successfully:', data);
        }
      } catch (audioErr) {
        console.error('Failed to create audio_messages bucket:', audioErr);
      }
    } else {
      console.log('audio_messages bucket already exists');
      
      // Ensure it's public
      try {
        const { data, error } = await supabase.storage.updateBucket('audio_messages', {
          public: true,
          fileSizeLimit: 10485760,
          allowedMimeTypes: ['audio/*']
        });
        
        if (error) {
          console.error('Error updating audio_messages bucket settings:', error);
        } else {
          console.log('Updated audio_messages bucket successfully:', data);
        }
      } catch (updateErr) {
        console.error('Error updating audio_messages bucket settings:', updateErr);
      }
    }
    
    console.log("Storage buckets initialization complete");
  } catch (err) {
    console.error('Failed to initialize storage:', err);
  }
}

// Execute initialization function
createStorageBuckets();
